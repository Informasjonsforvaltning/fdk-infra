---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  namespace: monitoring
  name: config
  labels:
    manager: default
spec:
  receivers:
    - name: slack
      slackConfigs:
        - apiURL:
            name: alertmanager-slack
            key: apiurl
          channel: fdk-staging-alerts
          sendResolved: true
          username: Alertmanager
          title: |
            {{- if (index .Alerts 0).Annotations.summary -}}
              {{ (index .Alerts 0).Annotations.summary }}
            {{- else if .CommonLabels.alertname -}}
              {{ .CommonLabels.alertname }}
            {{- else -}}
              Alert
            {{- end -}}
            {{- " " -}}
            {{- if eq .CommonLabels.severity "critical" -}}
              🔥
            {{- else if eq .CommonLabels.severity "error" -}}
              ❌
            {{- else if eq .CommonLabels.severity "warning" -}}
              ⚠️
            {{- else if eq .CommonLabels.severity "info" -}}
              ℹ️
            {{- else -}}
              ❕
            {{- end }}
          pretext: ""
          # {{- if eq .Status "firing" -}}
          #   *Started at:* {{ .StartsAt }}
          # {{ else }}
          #   *Ended at:* {{ .EndsAt }}
          # {{- end -}}
          # {{- "\n" -}}
          # {{- if .Annotations.summary -}}
          #   *{{ .Annotations.summary }}*
          #    {{- "\n" -}}
          # {{- end -}}
          text: |
            {{ range .Alerts }}
              {{- if .Annotations.description -}}
                > _{{ .Annotations.description }}_
                {{- "\n" -}}
              {{- end -}}
              {{- " " -}}• alertname: `{{ .Labels.alertname }}`
              {{- "\n" -}}
              {{- if .Labels -}}
                {{- range .Labels.SortedPairs -}}
                  {{- if not (or (eq .Name "alertname") (eq .Name "severity") (eq .Name "prometheus") (eq .Name "integration")) -}}
                    {{- " " -}}• {{ .Name }}: `{{ .Value }}`
                    {{- "\n" -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{ end }}
          iconURL: https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Prometheus_software_logo.svg/256px-Prometheus_software_logo.svg.png
          # fields:
          #   - title: Label
          #     value: |-
          #       alertname
          #       {{- "\n" -}}
          #       {{- range .Alerts -}}
          #         {{- range .Labels.SortedPairs -}}
          #           {{- if not (or (eq .Name "alertname") (eq .Name "severity") (eq .Name "prometheus") (eq .Name "integration")) -}}
          #             {{ .Name }}
          #             {{- "\n" -}}
          #           {{- end -}}
          #         {{- end -}}
          #       {{- end -}}
          #     short: true
          #   - title: Value
          #     value: |-
          #       {{- range .Alerts -}}
          #         `{{ .Labels.alertname }}`
          #         {{- "\n" -}}
          #         {{- range .Labels.SortedPairs -}}
          #           {{- if not (or (eq .Name "alertname") (eq .Name "severity") (eq .Name "prometheus") (eq .Name "integration")) -}}
          #             `{{ .Value }}`
          #             {{- "\n" -}}
          #           {{- end -}}
          #         {{- end -}}
          #       {{- end -}}
          #     short: true
          actions:
            - type: button
              text: "Query :mag:"
              url: "{{ (index .Alerts 0).GeneratorURL }}"
            - type: button
              text: "Dashboard :chart_with_upwards_trend:"
              url: "{{ (index .Alerts 0).Annotations.dashboard_url }}"
            - type: button
              text: "Silence :no_bell:"
              url: |
                {{ .ExternalURL }}/#/silences/new?filter=%7B
                {{- range .CommonLabels.SortedPairs -}}
                    {{- if ne .Name "alertname" -}}
                        {{- .Name }}%3D"{{- .Value -}}"%2C%20
                    {{- end -}}
                {{- end -}}
                alertname%3D"{{- .CommonLabels.alertname -}}"%7D
  route:
    groupBy:
      - alertname
    groupWait: 10s
    groupInterval: 1m
    repeatInterval: 1m
    receiver: slack
